---
- name: Symlink ComfyUI models, input, output, and temp directories
  hosts: spark_primary
  become: yes

  tasks:
    - name: Check if storage models directory exists
      stat:
        path: "{{ nfs_models_path }}"
      register: nfs_models_stat
      when: nfs_models_path != ""

    - name: Check if storage input directory exists
      stat:
        path: "{{ nfs_input_path }}"
      register: nfs_input_stat
      when: nfs_input_path != ""

    - name: Check if storage output directory exists
      stat:
        path: "{{ nfs_output_path }}"
      register: nfs_output_stat
      when: nfs_output_path != ""

    - name: Check if storage temp directory exists
      stat:
        path: "{{ nfs_temp_path }}"
      register: nfs_temp_stat
      when: nfs_temp_path != ""

    - name: Fail if storage directories are not available
      fail:
        msg: "Storage directory {{ item.path }} does not exist or is not accessible"
      when: item.path != "" and not item.stat.stat.exists
      loop:
        - { path: "{{ nfs_models_path }}", stat: "{{ nfs_models_stat }}" }
        - { path: "{{ nfs_input_path }}", stat: "{{ nfs_input_stat }}" }
        - { path: "{{ nfs_output_path }}", stat: "{{ nfs_output_stat }}" }
        - { path: "{{ nfs_temp_path }}", stat: "{{ nfs_temp_stat }}" }

    - name: Check if models directory exists and is not a symlink
      stat:
        path: "{{ comfyui_app_dir }}/models"
      register: models_check

    - name: Check if input directory exists and is not a symlink
      stat:
        path: "{{ comfyui_app_dir }}/input"
      register: input_check

    - name: Check if output directory exists and is not a symlink
      stat:
        path: "{{ comfyui_app_dir }}/output"
      register: output_check

    - name: Check if temp directory exists and is not a symlink
      stat:
        path: "{{ comfyui_app_dir }}/temp"
      register: temp_check

    - name: Remove existing models directory if it exists and is not a symlink
      file:
        path: "{{ comfyui_app_dir }}/models"
        state: absent
      when: models_check.stat.exists and not models_check.stat.islnk

    - name: Remove existing input directory if it exists and is not a symlink
      file:
        path: "{{ comfyui_app_dir }}/input"
        state: absent
      when: input_check.stat.exists and not input_check.stat.islnk

    - name: Remove existing output directory if it exists and is not a symlink
      file:
        path: "{{ comfyui_app_dir }}/output"
        state: absent
      when: output_check.stat.exists and not output_check.stat.islnk

    - name: Remove existing temp directory if it exists and is not a symlink
      file:
        path: "{{ comfyui_app_dir }}/temp"
        state: absent
      when: temp_check.stat.exists and not temp_check.stat.islnk

    - name: Create symlink for models directory
      file:
        src: "{{ nfs_models_path }}"
        dest: "{{ comfyui_app_dir }}/models"
        state: link
        force: yes
        owner: root
        group: "{{ comfyui_group }}"
      when: nfs_models_path != ""

    - name: Create symlink for input directory
      file:
        src: "{{ nfs_input_path }}"
        dest: "{{ comfyui_app_dir }}/input"
        state: link
        force: yes
        owner: root
        group: "{{ comfyui_group }}"
      when: nfs_input_path != ""

    - name: Create symlink for output directory
      file:
        src: "{{ nfs_output_path }}"
        dest: "{{ comfyui_app_dir }}/output"
        state: link
        force: yes
        owner: root
        group: "{{ comfyui_group }}"
      when: nfs_output_path != ""

    - name: Create symlink for temp directory
      file:
        src: "{{ nfs_temp_path }}"
        dest: "{{ comfyui_app_dir }}/temp"
        state: link
        force: yes
        owner: root
        group: "{{ comfyui_group }}"
      when: nfs_temp_path != ""

    - name: Verify symlinks are created correctly
      stat:
        path: "{{ item }}"
      register: symlink_check
      loop:
        - "{{ comfyui_app_dir }}/models"
        - "{{ comfyui_app_dir }}/input"
        - "{{ comfyui_app_dir }}/output"
        - "{{ comfyui_app_dir }}/temp"

    - name: Display symlink summary
      debug:
        msg: |
          ========================================
          ComfyUI Directory Symlinks Created!
          ========================================
          Models:  {{ comfyui_app_dir }}/models -> {{ nfs_models_path }}
          Input:   {{ comfyui_app_dir }}/input -> {{ nfs_input_path }}
          Output:  {{ comfyui_app_dir }}/output -> {{ nfs_output_path }}
          Temp:    {{ comfyui_app_dir }}/temp -> {{ nfs_temp_path }}
          
          All directories now point to local ZFS storage.
          Original directories have been removed and replaced with symlinks.
